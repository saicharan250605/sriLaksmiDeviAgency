<% layout("/layouts/boilerPlate") %>
<body>
    <div id="indDealer_invoicesHolder" style="margin-top: 35px;">
        <div style="height:100px; width:100%; display:flex; justify-content: center;margin-bottom: 25px;">
            <div style="height: 100%;
            width:90%;
            border-radius: 7px;
            display: flex;
            justify-content: center;
            align-items: center;
            background:linear-gradient(to right, rgb(103, 232, 249), rgb(147, 197, 253), rgb(249, 168, 212));">
                <div style="width:99%;
                height:82%;
                background-color: white;
                border-radius: 7px;
                display:flex;
                align-items: center;">
                    <div style="width:75%;height:75%;box-sizing: border-box;padding-left: 15px;">
                        <div style="color: #00BFFF;font-size: 25px;font-weight: 550;text-transform: capitalize;">
                            Dealer <%=currDealerInfo.name.toLowerCase()%> export invoices
                        </div>
                        <div style="font-size: 15px;">Manage and track all your export invoices</div>
                    </div>
                    <%if(reqUser !== undefined){%>
                    <div id="addPayment_dealer" style="width:25%;
                    height:75%;
                    color:rgb(248, 144, 201);
                    font-size: 19px;
                    display: flex;
                    align-items: center;
                    justify-content:end;
                    box-sizing: border-box;
                    padding-right: 25px;
                    cursor: pointer;
                    font-weight: 550;">
                        Add Payment
                    </div>
                    <%}%>
                </div>
            </div>
        </div>
        <table id="indDealer_exports_table">
            <caption style="background: linear-gradient(to right, rgb(34, 197, 94), rgb(5, 150, 105));">Exports Invoices</caption>
            <tr class="all_invoices_rows" style="background: linear-gradient(to right, rgb(220, 252, 231), rgb(209, 250, 229));">
                <th>Date</th>
                <th>Invoice</th>
                <th>Total Amount</th>
                <th>Download Invoice</th>
                <%if(reqUser !== undefined){%> <th>Delete</th><%}%>
            </tr>
            <% for(i of currDealerInfo.exports){ %>
            <tr class="all_invoices_rows" style="position:relative;" class="exportRows">
                <td class="all_invoices_data_rows"><%= new Date(i.date).toLocaleDateString()%></td>
                <td class="all_invoices_data_rows"><%= i.invoice %></td>
                <td class="all_invoices_data_rows"><%= i.totalReceivable.toFixed(3) %></td>
                <td class="all_invoices_data_rows" style="font-size: 25px;cursor:pointer;color:brown">
                    <i class="fa-solid fa-download"></i>
                    <div>
                        <div style="display: flex;align-items: center;border-bottom: 1px solid white;height:35px;">
                            <div style="width:31%;color:#67e8f9">Item</div>
                            <div style="width:23%;color:#67e8f9">Count</div>
                            <div style="width:23%;color:#67e8f9">Ind item cost</div>
                            <div style="width:23%;color:#67e8f9">Total Cost</div>
                        </div>
                    <%for(j of i.productSold){ %>
                        <div style="display: flex">
                            <div style="width:31%;color:#e0e2e3;<%if(j.itemName.length>12){%>font-size:12px;<%}%>"><%=j.itemName%></div>
                            <div style="width:23%;color:#e0e2e3"><%=j.number%></div>
                            <div style="width:23%;color:#e0e2e3"><%=j.indCost.toFixed(3)%></div>
                            <div style="width:23%;color:#86efac"><%=(Number(j.number)*Number(j.indCost)).toFixed(3)%></div>
                        </div>
                    <% } %>
                        <div style="display:flex;align-items: center;border-top:1px solid white;height:30px;">
                            <div style="width:50%;text-align: right;margin-left:auto;color:#fde047">Total ( before gst ) :</div>
                            <div style="width:25%;color:#86efac"><%=((i.totalReceivable*100)/(100+i.cgst+i.sgst)).toFixed(3)%></div>
                        </div>
                        <div style="display:flex;flex-direction: column;border-top:1px solid white;color:#ffab91;row-gap: 5px;">
                            <div style="display: flex; margin-left:30%;width:70%">
                                <div style="width:33%;">cgst</div>
                                <div style="width:34%;"><%=i.cgst%> %</div>
                                <div style="width:33%;color:#ffb74d;"><%=(((i.totalReceivable*100)/(100+i.cgst+i.sgst))*(i.cgst/100)).toFixed(3)%></div>
                            </div>
                            <div style="display: flex;margin-left:30%;width: 70%;">
                                <div style="width:33%;">sgst</div>
                                <div style="width:34%;"><%=i.sgst%> %</div>
                                <div style="width:33%;color:#ffb74d;"><%=(((i.totalReceivable*100)/(100+i.cgst+i.sgst))*(i.sgst/100)).toFixed(3)%></div>
                            </div>
                        </div>
                        <div style="display:flex;align-items: center;border-top:1px solid white;height:30px;">
                            <div style="width:25%;margin-left:auto;color:#fde047">Total:</div>
                            <div style="width:25%;color:#86efac"><%=(i.totalReceivable).toFixed(3)%></div>
                        </div>
                    </div>
                </td>
                <%if(reqUser !== undefined){%> <td class="all_invoices_data_rows">
                    <form action="/delete/export/<%=i._id%>?_method=DELETE" method="post" class="deleteDealer_invoiceForm">
                        <i class="fa-solid fa-trash-can" style="color:red;cursor:pointer;"></i>
                    </form>
                </td> <%}%>
            </tr>
            <% } %>
        </table>
        <br><br>
        <table id="indDealer_payments_table">
            <caption style="background: linear-gradient(to right, rgb(249, 115, 22), rgb(234, 88, 12));">Payments</caption>
            <tr class="all_invoices_rows" style="background: linear-gradient(to right, rgb(255, 237, 213), rgb(254, 215, 170));">
                <th>Date</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Transaction id</th>
                <%if(reqUser !== undefined){%><th>Delete</th><%}%>
            </tr>
            <% for(let i of currDealerInfo.payments){ %>
                <tr class="all_invoices_rows">
                    <td class="all_invoices_data_rows"><%= new Date(i.date).toLocaleDateString()%></td>
                    <td class="all_invoices_data_rows"<%if(i.amountType === "RECEIVED"){%>style="color:#4CBB17;font-weight:650;"<%}else{%>style="color:red;font-weight:650;"<%}%>><%=i.amountType%></td>
                    <td class="all_invoices_data_rows"><%=i.money%></td>
                    <td class="all_invoices_data_rows"><%=i.transactionId || "null"%></td>  
                    <%if(reqUser !== undefined){%>
                        <td class="all_invoices_data_rows">
                            <form action="/delete/payment/dealer/<%=currDealerInfo.id%>/<%=i._id%>?_method=DELETE" method="post" class="delete_payment_dealer">
                                <i class="fa-solid fa-trash-can" style="color:red;cursor:pointer;"></i>
                            </form>
                        </td> 
                    <%}%>
                </tr>
            <% } %>
        </table>
        <br>
        <div class="net_outstanding_balance_holder_div">
            <div style="width: 60%;height:100%;display: flex;">
                <div style="width:34%;margin-left: auto;text-align: center;box-sizing: border-box;padding-top: 5px;">Net Outstanding Balance :</div>
                <table style="width:33%;border:1px solid black;">
                    <tr style="height: 45%;">
                        <th>Receivable</th>
                        <th>Payable</th>
                    </tr>
                    <tr style="height:55%;">
                        <td style="border-right: 1px solid black;text-align: center;color:#009E60;font-weight: 550;" id="receivable_amount"></td>
                        <td style="text-align: center;color:red;font-weight: 550;" id="payable_amount"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div id="deleteConfirmation_div_dealer_invoice">
        <i class="fa-solid fa-xmark xmark_del_dealer_invoice"></i>
        <span></span>
        <div id="deleteConfirm_btn_dealer_invoice">Delete</div>
    </div>
    <div id="deleteConfirmation_div_dealer_payment">
        <i class="fa-solid fa-xmark xmark_del_dealer_payment"></i>
        <span></span>
        <div id="deleteConfirm_btn_dealer_payment">Delete</div>
    </div>
    <div id="addPayment_dealerForm_holder_div">
        <form action="/addPayment/dealer/<%=currDealerInfo.id%>" id="addPayment_dealer_form" method="post">
        <i class="fa-solid fa-xmark xmark_addPayment_dealer"></i>
        <label for="addPayment_dealer_date">Date of payment</label>
        <input type="date" id="addPayment_dealer_date" name="dealerPayment[date]" required>
        <label for="addPayment_dealer_paymentType">Transaction type</label>
        <select name="dealerPayment[amountType]" id="addPayment_dealer_paymentType" required>
            <option value="" hidden disable>select any one payment type</option>
            <option value="received">Received</option>
            <option value="paid">Paid</option>
        </select>
        <label for="addPayment_dealer_amount">Amount paid</label>
        <input type="number" step="any" id="addPayment_dealer_amount" name="dealerPayment[money]" placeholder="Enter amount debited or credited" required>
        <label for="addPayment_dealer_transactionId">Transaction id</label>
        <input type="text" id="addPayment_dealer_transactionId" name="dealerPayment[transactionId]" placeholder="Enter Transaction id" required>
        <button id="addpayment_dealer_form_submitBtn">ADD</button>
        </form>
    </div>
    <script>
        const currDealerInfo = <%-JSON.stringify(currDealerInfo)%>;
        const exportsAmount = <%-JSON.stringify(currDealerInfo.exports)%>;
        const paymentAmount = <%-JSON.stringify(currDealerInfo.payments)%>;
    </script>
    <script>
        /////////////////////////////////////////////////////////  DELETE EXPORTs HANDLER ///////////////////////////////////////////////////////////
        const deleteDealer_invoiceForm = document.querySelectorAll(".deleteDealer_invoiceForm");
        const deleteConfirmation_div_dealer_invoice = document.querySelector("#deleteConfirmation_div_dealer_invoice");
        const xmark_del_dealer_invoice = document.querySelector(".xmark_del_dealer_invoice");
        const deleteConfirm_btn_dealer_invoice = document.querySelector("#deleteConfirm_btn_dealer_invoice");
        const indDealer_invoicesHolder = document.querySelector("#indDealer_invoicesHolder");
        const navbar = document.querySelector("#navbar");

        for(let i of deleteDealer_invoiceForm){
            i.children[0].addEventListener('click',dealerDelete_handler);
        }
        xmark_del_dealer_invoice.addEventListener("click",()=>{
            indDealer_invoicesHolder.style.display="flex";
            deleteConfirmation_div_dealer_invoice.style.display="none";
            navbar.style.pointerEvents="all";
        });
        function dealerDelete_handler(event){
            navbar.style.pointerEvents="none";
            indDealer_invoicesHolder.style.display="none";
            deleteConfirmation_div_dealer_invoice.style.display="flex";
            deleteConfirmation_div_dealer_invoice.children[1].innerText=`Are you sure, you want to delete invoice dated on ${event.target.parentElement.parentElement.parentElement.children[0].innerText}?`;
            deleteConfirm_btn_dealer_invoice.addEventListener("click",()=>{
                event.target.parentElement.submit();
            });
        }
        /////////////////////////////////////////////////////////// ADDING PAYMENTS OF DEALERS ////////////////////////////////////////////////////
        let addPayment_dealer = document.querySelector("#addPayment_dealer");
        let addPayment_dealerForm_holder_div = document.querySelector("#addPayment_dealerForm_holder_div");
        let xmark_addPayment_dealer = document.querySelector(".xmark_addPayment_dealer");
        let indDealer_exports_table = document.querySelector("#indDealer_exports_table");
        let indDealer_payments_table = document.querySelector("#indDealer_payments_table");
        addPayment_dealer.addEventListener("click",addPaymentFormFetch);

        function addPaymentFormFetch(){
            addPayment_dealerForm_holder_div.style.display="block";
            xmark_addPayment_dealer.addEventListener("click",wrongButton_addPayment_dealer);
            indDealer_invoicesHolder.style.display="none";
            navbar.style.pointerEvents="none";
        }
        function wrongButton_addPayment_dealer(){
            addPayment_dealerForm_holder_div.style.display="none";
            indDealer_invoicesHolder.style.display="flex";
            navbar.style.pointerEvents="all";
            xmark_addPayment_dealer.removeEventListener("click",wrongButton_addPayment_dealer);
        }
        ///////////////////////////////////////////////////////// DELETE PAYMENTs HANDLER ///////////////////////////////////////////////////////////
        const delete_payment_dealer = document.querySelectorAll(".delete_payment_dealer");
        const deleteConfirmation_div_dealer_payment = document.querySelector("#deleteConfirmation_div_dealer_payment");
        const xmark_del_dealer_payment = document.querySelector(".xmark_del_dealer_payment");
        const deleteConfirm_btn_dealer_payment = document.querySelector("#deleteConfirm_btn_dealer_payment");

        for(let i of delete_payment_dealer){
            i.children[0].addEventListener('click',dealer_paymentDelete_handler);
        }
        xmark_del_dealer_payment.addEventListener("click",()=>{
            navbar.style.pointerEvents="all";
            indDealer_invoicesHolder.style.display="flex";
            deleteConfirmation_div_dealer_payment.style.display="none";
        });
        function dealer_paymentDelete_handler(event){
            navbar.style.pointerEvents="none";
            indDealer_invoicesHolder.style.display="none";
            deleteConfirmation_div_dealer_payment.style.display="flex";
            deleteConfirmation_div_dealer_payment.children[1].innerText=`Are you sure, you want to delete this payment dated on ${event.target.parentElement.parentElement.parentElement.children[0].innerText}?`;
            deleteConfirm_btn_dealer_payment.addEventListener("click",()=>{
                event.target.parentElement.submit();
            });
        }
        //////////////////////////////////////////////////////////// TOTAL NET OUTSTANDING AMOUNT CALCULATION ///////////////////////////////////////////////////////
        let payable_amount = document.querySelector("#payable_amount");
        let receivable_amount = document.querySelector("#receivable_amount");
        let totalExportAmount = 0;
        let totalPaymentAmount = 0;
        for(let i of exportsAmount){
            totalExportAmount += i.totalReceivable;
        }
        for(let i of paymentAmount){
            if(i.amountType === "RECEIVED"){
                totalPaymentAmount -= i.money;
            }else if(i.amountType === "PAID"){
                totalPaymentAmount += i.money;
            }
        }
        if(totalExportAmount + totalPaymentAmount >=0){
            receivable_amount.innerText = Math.abs(totalExportAmount + totalPaymentAmount).toLocaleString("en-IN");
            payable_amount.innerText = 0;
        }else if(totalExportAmount + totalPaymentAmount < 0){
            receivable_amount.innerText = 0;
            payable_amount.innerText = Math.abs(totalExportAmount + totalPaymentAmount).toLocaleString("en-IN");
        }
    </script>
    <script src="/JS/invoiceDownload.js"></script>
</body>